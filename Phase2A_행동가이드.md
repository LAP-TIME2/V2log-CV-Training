# Phase 2A 행동 가이드 — YOLO 무게 감지 모델 학습

> V2log 앱에서 카메라로 바벨을 비추면 무게를 자동 감지하는 AI 모델을 만드는 과정.
> **입력**: 헬스장 플레이트 사진 3,000~5,000장 → **출력**: `weight_plate.tflite` 파일 1개

---

## Step 1: 사진 촬영 (헬스장에서 직접)

**목표**: 3,000~5,000장 (3~4회 헬스장 방문)

### 1차 촬영 (파일럿)

| 순서 | 할 일 | 목표량 | 시간 |
|------|-------|--------|------|
| 1 | 플레이트 기구에서 빼서 개별 촬영 | 7종 × 15장 = ~105장 | 15분 |
| 2 | 바벨에 조합별로 끼워서 촬영 | 8조합 × 8장 = ~64장 | 15분 |
| 3 | 빈 바벨 촬영 | 10장 | 3분 |
| | **합계** | **~180장** | **~33분** |

### 촬영 체크리스트 (매 플레이트/조합마다)

```
□ 앞면 정면 (숫자/로고 보이게)
□ 뒷면
□ 측면 (두께)
□ 45도 대각선
□ 가까이 (플레이트만 꽉 차게)
□ 멀리 (주변 환경 포함)
□ 밝은 곳에서
□ 어두운 곳에서
```

### 촬영 우선순위

```
1순위: 20kg, 10kg, 5kg     ← 가장 많이 쓰는 무게
2순위: 15kg, 25kg, 2.5kg
3순위: 1.25kg              ← 있는 헬스장이 드뭄
```

### 바벨 조합 촬영 목록

```
□ 빈 바벨
□ 20kg × 1
□ 20kg + 10kg
□ 20kg + 5kg
□ 20kg + 10kg + 5kg
□ 10kg × 2
□ 15kg + 5kg
□ 25kg (있으면)
```

### 촬영 팁

- 폰 기본 카메라앱 사용 (별도 앱 불필요)
- 플래시 끄기 (자연광이 학습에 더 좋음)
- 세로/가로 둘 다 OK
- **지저분해도 OK** — 실제 헬스장 환경이 학습에 오히려 좋음
- 다른 사람 얼굴은 안 나오게 주의

### 1차 촬영 후 할 일

1. **사진을 PC로 옮기기** — USB 케이블 또는 Google Photos
2. `C:\Dev\V2log-CV-Training\data\images\` 폴더에 일단 다 넣기
3. 사진 훑어보면서 **흐릿한 것, 대상이 안 보이는 것 삭제**
4. 남은 장수 확인 → 부족한 클래스 파악

### 2~3차 촬영 (다른 헬스장)

| 차수 | 목표 | 핵심 |
|------|------|------|
| 2차 | +1,000장 | **다른 헬스장**에서 (다른 브랜드 플레이트) |
| 3차 | +1,000장 | 부족한 클래스 집중 촬영 |
| 4차 (필요시) | +500장 | 약한 클래스 보충 |

**다른 헬스장이 중요한 이유**: 같은 헬스장 사진만 쓰면 AI가 "이 특정 플레이트"만 학습함. 다른 헬스장의 다른 브랜드/색상 플레이트를 봐야 **범용적으로** 인식함.

---

## Step 2: Roboflow 라벨링

AI한테 "이 사진에서 이 부분이 20kg 플레이트야"라고 알려주는 작업.

### 2-1. Roboflow 계정 만들기

1. https://roboflow.com 접속
2. Google 계정으로 회원가입 (무료)
3. **"Create New Project"** 클릭
4. 설정:
   - Project Name: `v2log-weight-plates`
   - Project Type: **Object Detection**
   - Annotation Group: `weight-plates`
5. 프로젝트 생성 완료

### 2-2. 사진 업로드

1. **"Upload Images"** 클릭
2. PC에서 사진 전체 선택 → 드래그 앤 드롭
3. 업로드 완료 대기 (1,000장 기준 5~10분)

### 2-3. 라벨링 (바운딩 박스 그리기)

**이게 가장 시간 많이 걸리는 작업** (500장에 약 3~4시간)

1. 사진 하나 클릭 → 라벨링 화면 진입
2. 플레이트가 보이는 부분에 **마우스로 사각형(바운딩 박스)** 그리기
3. 클래스 선택: `plate_20kg`, `plate_10kg` 등
4. 한 사진에 플레이트 여러 개면 **각각** 박스 그리기
5. 다음 사진으로 넘기기 → 반복

```
예시: 바벨에 20kg + 10kg 끼운 사진
→ 20kg 플레이트에 박스 1개 (클래스: plate_20kg)
→ 10kg 플레이트에 박스 1개 (클래스: plate_10kg)
→ 바벨 전체에 박스 1개 (클래스: barbell)
= 총 3개 박스
```

### 라벨링 팁

- 박스는 **플레이트에 딱 맞게** (너무 크거나 작지 않게)
- 반쯤 가려진 플레이트도 **보이는 부분만** 박스
- 완전히 가려져서 안 보이면 **박스 안 그림**
- 핵심: **정확도 > 속도** (잘못된 라벨 100장보다, 정확한 라벨 50장이 나음)

### 2-4. AI 보조 라벨링 (효율 10배)

500장 수동 라벨링 하면 Roboflow에서 **자동 라벨링 기능** 사용 가능:

1. 500장 수동 완료 후 → **"Train" 버튼** 클릭 (임시 모델 학습)
2. 학습 완료 (~30분) → 나머지 사진에 **자동 라벨 제안**이 뜸
3. 사진마다 제안된 박스를 **확인만** 하면 됨:
   - 맞으면 → **Enter** (승인)
   - 틀리면 → 수정 후 승인
4. 속도: 수동 1장 30초 → AI 보조 1장 3~5초

### 2-5. 데이터 증강 + Export

1. Roboflow에서 **"Generate"** 탭 클릭
2. 증강 옵션 선택:
   - ✅ Flip (좌우 반전)
   - ✅ Rotation (±15°)
   - ✅ Brightness (±25%)
   - ✅ Blur (약간)
   - ✅ Noise
3. **"Generate"** 클릭 → 원본 ×3~5배 자동 생성
4. 분할 비율: **Train 70% / Val 20% / Test 10%**
5. **"Export"** → Format: **YOLOv11** → 다운로드
6. 다운로드된 폴더 내용을 `V2log-CV-Training/data/`에 덮어쓰기

---

## Step 3: Google Colab에서 학습

### 3-1. Colab 열기

1. https://colab.research.google.com 접속
2. Google 계정 로그인
3. **"새 노트북"** 생성
4. 메뉴: **런타임 → 런타임 유형 변경 → T4 GPU** 선택
5. **"저장"**

### 3-2. 셀 4개 순서대로 실행

**셀 1: 패키지 설치** (1분)
```python
!pip install ultralytics roboflow
```
▶ 버튼 클릭 → 설치 로그 나오면 완료

**셀 2: Roboflow에서 데이터 가져오기** (2~5분)
```python
from roboflow import Roboflow

rf = Roboflow(api_key="여기에_API키_입력")
project = rf.workspace().project("v2log-weight-plates")
dataset = project.version(2).download("yolov8")
```

> **API 키 찾는 법**: Roboflow → 우측 상단 프로필 → Settings → API Key → 복사

▶ 실행 → `data/` 폴더에 사진+라벨이 다운로드됨

**셀 3: 학습 시작** (2~4시간)
```python
from ultralytics import YOLO

model = YOLO('yolo26n.pt')
results = model.train(
    data='v2log-weight-plates-1/data.yaml',
    epochs=100,
    imgsz=640,
    batch=16,
    patience=20,
)
```

▶ 실행 → **2~4시간 걸림** (Colab 탭 닫지 마세요!)

진행 상황이 이렇게 나옴:
```
Epoch 1/100:  loss=12.3  mAP50=0.15
Epoch 10/100: loss=5.2   mAP50=0.45
Epoch 50/100: loss=1.8   mAP50=0.72
Epoch 85/100: loss=1.2   mAP50=0.83  ← 이 정도면 성공
```

**셀 4: 결과 확인**
```python
print(f"mAP50: {results.results_dict['metrics/mAP50(B)']:.1%}")
print(f"mAP50-95: {results.results_dict['metrics/mAP50-95(B)']:.1%}")
```

### 3-3. 결과 판정

| mAP50 | 판정 | 다음 행동 |
|-------|------|----------|
| **80% 이상** | 통과! | Step 4로 → 변환 |
| **60~80%** | 개선 필요 | 데이터 추가 500~1,000장 → 재학습 |
| **60% 미만** | 부족 | 라벨링 품질 점검 + 데이터 1,000장 추가 |

---

## Step 4: 검증 (테스트 데이터로 확인)

학습에 안 쓴 **테스트 사진**으로 실제 성능을 확인.

**셀 5: 검증 실행**
```python
model = YOLO('runs/detect/train/weights/best.pt')
results = model.val(data='v2log-weight-plates-1/data.yaml', split='test')
```

### 확인할 것

1. **전체 mAP50**: 80% 이상인지
2. **클래스별 정확도**: 특정 무게가 유독 낮은지

```
예시 결과:
plate_25kg:   85%  ← OK
plate_20kg:   92%  ← 좋음
plate_15kg:   78%  ← 약간 부족, 사진 추가 고려
plate_10kg:   88%  ← OK
plate_5kg:    82%  ← OK
plate_2.5kg:  65%  ← 낮음! 이 무게 사진 더 찍어야 함
plate_1.25kg: 58%  ← 낮음! 작은 플레이트라 인식 어려움
barbell:      90%  ← 좋음
empty_barbell: 94% ← 좋음
```

### 약한 클래스 발견 시

1. 해당 무게 플레이트 사진 **200~300장 추가 촬영**
2. Roboflow에 추가 업로드 + 라벨링
3. **재학습** (셀 3 다시 실행)

---

## Step 5: TFLite 변환

학습된 모델(.pt)을 **모바일에서 돌릴 수 있는 형식(.tflite)**으로 바꾸기.

**셀 6: 변환**
```python
model = YOLO('runs/detect/train/weights/best.pt')
model.export(format='tflite', half=True, imgsz=640)
```

▶ 실행 → 1~2분 → `best_float16.tflite` 파일 생성

**셀 7: 파일 크기 확인**
```python
import os
size = os.path.getsize('runs/detect/train/weights/best_float16.tflite')
print(f"모델 크기: {size / 1024 / 1024:.1f} MB")
```

| 크기 | 판정 |
|------|------|
| **< 10MB** | 앱에 넣기 적합 |
| **10~20MB** | 쓸 수 있지만 앱 용량 주의 |
| **> 20MB** | 모델 경량화 필요 (YOLO26n이면 보통 4~8MB) |

---

## Step 6: 파일 다운로드 + V2log에 전달

1. Colab 왼쪽 **파일 탐색기** 열기
2. `runs/detect/train/weights/best_float16.tflite` 찾기
3. **우클릭 → 다운로드**
4. 다운로드된 파일 처리:

```
다운로드 폴더의 best_float16.tflite
    ↓ 이름 변경
weight_plate.tflite
    ↓ 복사
C:\Dev\V2log-CV-Training\models\   ← 보관용
C:\Dev\V2log\assets\models\        ← 앱에서 사용 (Phase 2B)
```

5. **Phase 2A 완료!** → Phase 2B (앱 통합) 시작

---

## 전체 타임라인 요약

| 단계 | 할 일 | 도구 | 예상 시간 |
|------|-------|------|----------|
| **토요일** | 1차 촬영 (~180장) | 폰 카메라 | 30분 |
| **토요일 저녁** | Roboflow 가입 + 업로드 + 라벨링 시작 | 웹 브라우저 | 1시간 |
| **평일 틈틈이** | 수동 라벨링 500장 | 웹 브라우저 | 3~4시간 |
| **다음 주** | 2차 촬영 (다른 헬스장) | 폰 카메라 | 30분 |
| **라벨링 마무리** | AI 보조 라벨링 + 증강 | 웹 브라우저 | 1~2시간 |
| **학습** | Colab에서 돌리기 | 웹 브라우저 | 2~4시간 (대기) |
| **검증** | mAP 확인 + 필요시 재학습 | 웹 브라우저 | 30분 |
| **변환** | .tflite 변환 + 다운로드 | 웹 브라우저 | 10분 |
| | **총 능동 작업 시간** | | **~8시간** |

> 실제로 직접 해야 하는 건 **사진 촬영 + 라벨링**이 90%.
> 나머지 학습/변환은 **코드 복붙 + 기다리기**.

---

## 문제 발생 시 대응표

| 문제 | 원인 | 해결 |
|------|------|------|
| Colab 연결 끊김 | 무료 계정 제한 (12시간) | 체크포인트에서 이어서 학습 |
| mAP가 안 오름 | 데이터 부족 or 라벨 오류 | 라벨 품질 점검 + 사진 추가 |
| 특정 클래스만 낮음 | 해당 클래스 사진 부족 | 해당 무게만 200~300장 추가 |
| .tflite 변환 실패 | Ultralytics 버전 문제 | `!pip install ultralytics --upgrade` |
| 모델 크기 너무 큼 | 모델 선택 문제 | `yolo26n`(nano) 사용 확인 |
